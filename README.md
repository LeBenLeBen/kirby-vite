# Vite Helper for Kirby

A set of helper functions to get the correct path to your versioned css and js files generated by [vite](https://github.com/vitejs/vite). This plugin is highly inspired by [Diverently](https://github.com/Diverently)'s [Laravel Mix Helper for Kirby](https://github.com/Diverently/laravel-mix-kirby) and [André Felipe](https://github.com/andrefelipe)'s [vite-php-setup](https://github.com/andrefelipe/vite-php-setup).

## Use-cases

You can use `kirby-vite` for a single or multi-page vanilla js setup or as a basis for an SPA setup. If you plan to use `Kirby` together with `Vue 3` also checkout [Johann Schopplich](https://github.com/johannschopplich)'s [Kirby + Vue 3 Starterkit](https://github.com/johannschopplich/kirby-vue3-starterkit)!

## Installation

### Manual download

Download and copy this repository to `site/plugins/kirby-vite`.

### Git submodule

```
git submodule add https://github.com/arnoson/kirby-vite.git site/plugins/kirby-vite
```

### Composer

```
composer require arnoson/kirby-vite
```

## Usage

Make sure you have the right [setup](#setup).
Then inside your template files (or anywhere else) you can use the helper functions.

```php
<html>
  <head>
    <?= vite()->client() ?>
    <?= vite()->css() ?>
  </head>
  <body>
    <?= vite()->js() ?>
  </body>
</html>
```

## Quick start

- download one of the [examples](examples)
- run `composer install` inside the example's `/public` directory
- run `npm run dev` inside the example's root directory
- Visit `localhost:8888` in the browser and make some changes to the js and css files inside `/src`

## Setup

### Install Vite

Follow the instructions [here](https://vitejs.dev/guide/).

### Folder structure

With the default configuration, `kirby-vite` expects a folder structure like this:

```
.
├── public # Your complete kirby site.
│   ├── assets -> src/assets # A symlink to your assets folder.
│   ├── dist # Here goes everything that is automatically generated by vite for production.
│   │   ├── manifest.json # The manifest.json generated by vite.
│   │   └── assets # Your compiled assets.
│   ├── content
│   ├── kirby
│   ├── media
│   ├── site
│   └── ...
├── src # Your js and css source files.
│   ├── assets # Place your assets (images, fonts, ...) here.
│   ├── index.js
│   └── index.css
├── vite.config.js
├── node_modules
└── package.json

```

### Vite configuration

To match the folder structure described above, your `vite.config.js` should look something like this:

```js
// vite.config.js
export default {
  // `root` is important here if you want to use the name `public` for your
  // kirby folder. Vite treats the `public` folder special so in order to
  // prevent vite and kirby from clashing we have to make sure vite doesn't use
  // the project root. If you don't want to use the name `public` or put your
  // `vite.config.js` inside the `src` folder you don't have to do this.
  root: 'src',

  // Make sure kirby uses the correct path in production.
  base: process.env.APP_ENV === 'development' ? '/' : '/dist/',

  server: {
    // Required to load scripts from custom host.
    cors: true,
    // Resolve paths correctly.
    hmr: { host: 'localhost' },
    // Make sure the ports are matching.
    port: 3000,
    strictPort: true
  },

  build: {
    // Output directory for production build.
    outDir: '../public/dist',
    emptyOutDir: true,
    // Emit manifest so `kirby-vite` can find the hashed files.
    manifest: true,
    // Entry file.
    rollupOptions: {
      input: './src/index.js'
    }
  }
};
```

### Development

The last thing we have to do is let `kirby-vite` know when we are in development mode, so it can serve the right files.
To do this, add a kirby config file for your development domain ([learn more](https://getkirby.com/docs/guide/configuration#multi-environment-setup) about multi-environment setup).
Assuming you're running your development server on `my-site.test`:

```
├── config # Your kirby config folder
│   └── config.my-site.test.php
└── ...
```

```php
// config.my-site.test.php
return [
  // ...
  'arnoson.kirby-vite' => [
    'dev' => true
  ]
];
```

Now run `npm dev` (see [NPM scripts](#NPM-scripts)) and visit your kirby site in the browser. Note: we only use vite's dev server to serve our assets. So you can visit your kirby site under your php development server (in this example `my-site.test`).

## NPM scripts

When you created your vite app via `npm init @vitejs/app` (see [install vite](#-install-vite)), `vite` adds the following NPM scripts to your `package.json`:

```json
"scripts": {
  "dev": "vite",
  "build": "vite build",
  "preview": "vite serve"
}
```

We have to alter them like this to get our configuration to work:

```json
"scripts": {
  "dev": "APP_ENV=development vite",
  "build": "APP_ENV=production vite build"
}
```

## Plugin configuration

Make sure your plugin configuration matches your vite configuration.

```php
// config.php
return [
  'arnoson.kirby-vite' => [
    // Your default entry file.
    'entry' => 'index.js',
    // The dist directory for your production assets and manifest.json.
    'outDir' => 'dist',
    // The assets dir, relative to the dist dir.
    'assetsDir' => 'assets'
    // Wether or not to add `type="module"` to your entries script tags.
    'module' => true,
  ]
];
```

## Multi-page setup

Create a multi page setup as described [here](https://vitejs.dev/guide/build.html#multi-page-app)
(use js entries instead of html entries).
You can then pass your entry file names to `kirby-vites` helper functions:

```php
vite()->js('nested/index.js');
vite()->css('nested/index.js');
```

## Watch php files

If you also want to live reload your site in development mode whenever you change something in kirby, install [vite-plugin-live-reload](https://github.com/arnoson/vite-plugin-live-reload). Then adjust your `vite.config.js`:

```js
// vite.config.js
import liveReload from 'vite-plugin-live-reload';

export default {
  // ...
  plugins: [
    liveReload(
      '../public/site/(templates|snippets|controllers|models)/**/*.php'
    )
  ]
};
```

## Known issues

### Vite's dev server port

Make sure `vite` and `kirby-vite` are using the same port. `vite` will use port
`3000` by default. But if you have another `vite` dev server running, `vite` will
increase the port (`3001` and so on). So either make sure no other `vite` dev
server is running or specify another port in `kirby-vite`:

```php
'arnoson.kirby-vite.devServer' => 'http://localhost:1234'
```

### Static assets during development

To get static assets (images, fonts, ...) working during development you have to
create a symlink on your php dev server to match your assets folder:

```
cd {root_of_your_project}
ln -s $PWD/src/assets ./public/assets
```

More information [here](https://vitejs.dev/guide/backend-integration.html).
