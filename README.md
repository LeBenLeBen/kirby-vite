# Vite Helper for Kirby

Use the `vite` helper function to get the correct path to your versioned css and js files generated by [vite](https://github.com/vitejs/vite). This plugin is highly inspired by [Diverently](https://github.com/Diverently)'s [Laravel Mix Helper for Kirby](https://github.com/Diverently/laravel-mix-kirby).

## Installation

### Manual download
Download and copy this repository to `site/plugins/kirby-vite`.

### Git submodule
```
git submodule add https://github.com/arnoson/kirby-vite.git site/plugins/kirby-vite
```

### Composer
```
composer require arnoson/kirby-vite
```

## Usage
Make sure you have the right [setup](#setup).
Then inside your template files (or anywhere else) you can use the `vite` helper function.
```html
<html>
  <head>
    <?= vite('@style') ?> <!-- or vite('style.css') -->
    <?= vite('@client') ?>
  </head>
  <body>
    <?= vite('@entry') ?> <!-- or vite('index.js') -->
  </body>
</html>
```

## Setup

### Install vite
Follow the instructions [here](https://github.com/vitejs/vite#getting-started). Or without the use of `vite-app` you can just install vite with npm: `npm i vite --save-dev` (This is great for a simple vanilla js setup).

### Folder structure
With the default configuration, kirby-vite expects a folder structure like this:
```
.
├── public # Your complete kirby site.
│   ├── assets # Here vite automatically places my compiled assets for production.
│   ├── content
│   ├── kirby
│   ├── media
│   ├── site
│   └── ...
├── src # Your js and css source files.
│   ├── index.js
│   └── index.css
├── vite.config.js
├── node_modules
└── package.json

```

### Vite configuration
To match the folder structure described above, your `vite.config.js` should look something like this:
```js
// vite.config.js
export default {
  // `root` is important here if you want to use the name `public` for your
  // kirby folder. Vite treats the `public` folder special so in order to
  // prevent vite and kirby from clashing we have to make sure vite doesn't use
  // the project root. If you don't want to use the name `public` or put your
  // `vite.config.js` inside the `src` folder you don't have to do this.
  root: 'src',

  // Tweek as you like.
  entry: 'index.js',

  // `cors` is only important for development.
  cors: true,

  // Make sure vite emits a `manifest.json` file.
  emitManifest: true,

  // *Never* use `../public` as your `outDir` because vite will delete
  // everything within it (in this case your kirby site) every time it builds.
  // If you use `../public/assets` all your assets will be deleted, which can be
  // fine if you only use vite and no other assets.
  outDir: '../public/assets/dist',
  // We don't need an extra subdirectory inside our `outDir`.
  assetsDir: '/'
}
```

## NPM scripts
Add the following NPM scripts to your `package.json`:
```json
"scripts": {
  "dev": "vite",
  "build": "vite build"  
}
```

## Watch php files
If you also want to live reload your site in development mode whenever you change something in kirby install my [vite-plugin-live-reload](https://github.com/arnoson/vite-plugin-live-reload). Then adjust your `vite.config.js`:
```js
// vite.config.js
import liveReload from 'vite-plugin-live-reload'

export default {
  // ...
  plugins: [
    liveReload('public/site/(templates|snippets|controllers|models)/**/*.php'),
  ]
}
```

## Known issues
if you use a vanilla js setup without vue or another framework, changes on your entry file (`index.js`) won't cause a page reload in your kirby site. A workaround is to watch your entry file manually with [vite-plugin-live-reload](https://github.com/arnoson/vite-plugin-live-reload).
```js
// vite.config.js
import liveReload from 'vite-plugin-live-reload'

export default {
  // ...
  plugins: [
    liveReload('index.js')
    // Or if you aso want to watch php files:
    // liveReload([
    //  'src/index.js',
    //  'public/site/(templates|snippets|controllers|models)/**/*.php')
    // ])
  ]
}
```